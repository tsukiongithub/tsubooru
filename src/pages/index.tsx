import type { NextPage } from "next";

import { useRouter } from "next/router";
import { ChangeEvent, useEffect, useState } from "react";

import { trpc } from "../utils/trpc";

import Head from "next/head";
import Image from "next/image";
import Link from "next/link";

import isNumber from "@/common/isNumber";
import useWindowDimensions from "@/hooks/useWindowDimensions";

import Search from "@/components/Search";
import Paginator from "@/components/Paginator";

const Home: NextPage = () => {
	const router = useRouter();
	const { tags, pid, rating } = router.query;

	const { windowWidth } = useWindowDimensions();

	const [contentRating, setContentRating] = useState("");
	const [search, setSearch] = useState("");
	const [page, setPage] = useState(0);

	const [posts, setPosts] = useState<GelPost[]>([]);

	const { data: postsData, isSuccess: postsDataIsSuccess } = trpc.gelbooru.getPosts.useQuery(
		{ search: search, pid: page, rating: contentRating },
		{ refetchOnWindowFocus: false }
	);

	useEffect(() => {
		if (postsDataIsSuccess) {
			if (postsData && postsData.posts) {
				setPosts(postsData.posts.map((post) => post));
			} else {
				setPosts([]);
			}
		}
	}, [postsData, postsDataIsSuccess]);

	useEffect(() => {
		if (tags !== undefined) {
			if (tags.length > 0) {
				setSearch(tags as string);
			} else {
				setSearch("");
			}
		} else {
			router.query.tags = "";
		}
		router.push(router);
	}, [tags]);

	useEffect(() => {
		if (pid !== undefined) {
			setPage(isNumber(pid as string));
		} else {
			router.query.pid = "0";
		}
		router.push(router);
	}, [pid]);

	useEffect(() => {
		if (rating !== undefined) {
			setContentRating(rating as string);
		} else {
			router.query.rating = "safe";
		}
		router.push(router);
	}, [rating]);

	const handleContentRatingChange = (ev: ChangeEvent<HTMLInputElement>) => {
		const newRating = ev.currentTarget.value;
		console.log(newRating);
		router.query.rating = newRating;
		router.push(router);
	};

	return (
		<>
			<Head>
				<title>image viewer</title>
				<meta
					name="description"
					content="Generated by create-t3-app"
				/>
				<link
					rel="icon"
					href="/favicon.ico"
				/>
			</Head>
			<header className="w-full pb-8">
				<Search />
				<div className="flex items-center py-4">
					<label>
						<input
							type="radio"
							name="contentRating"
							value={"safe"}
							onChange={handleContentRatingChange}
							defaultChecked
						/>
						safe
					</label>
					<label>
						<input
							type="radio"
							name="contentRating"
							value={"nsfw"}
							onChange={handleContentRatingChange}
						/>
						nsfw
					</label>
				</div>
			</header>
			<main>
				<div className="py-8">
					{postsDataIsSuccess && (
						<div className="grid-flow-rows grid w-full gap-x-6 gap-y-12 sm:grid-cols-2 sm:px-0 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8">
							{posts.length >= 1 ? (
								posts.map((post, key) => {
									return (
										<article
											key={key}
											className="relative flex w-full flex-col"
										>
											<Link
												className="group flex h-auto max-h-full max-w-full items-center justify-center focus:outline-none sm:h-72 md:h-64 xl:h-48"
												href={post.file_url}
											>
												{windowWidth! < 640 ? (
													post.file_url.includes("video") ? (
														<Image
															className={`max-h-full max-w-full border-2 border-blue-500 object-contain focus:outline-none group-focus-visible:ring-2 group-focus-visible:ring-black`}
															src={post.sample_url || post.preview_url}
															alt={`${post.id}: ${post.tags}`}
															width={post.sample_width || post.preview_width}
															height={post.sample_height || post.preview_height}
														/>
													) : (
														<Image
															className={`max-h-full max-w-full object-contain focus:outline-none group-focus-visible:ring-2 group-focus-visible:ring-black`}
															src={post.file_url}
															alt={`${post.id}: ${post.tags}`}
															width={post.width}
															height={post.height}
														/>
													)
												) : (
													<Image
														className={`max-h-full max-w-full object-contain focus:outline-none group-focus-visible:ring-2 group-focus-visible:ring-black`}
														src={post.sample_url || post.preview_url}
														alt={`${post.id}: ${post.tags}`}
														width={post.sample_width || post.preview_width}
														height={post.sample_height || post.preview_height}
													/>
												)}
											</Link>
										</article>
									);
								})
							) : (
								<p>nothing found :/</p>
							)}
						</div>
					)}
				</div>
				<Paginator />
			</main>
		</>
	);
};

export default Home;
